---
import '../styles/week.css';
import '../styles/site.css';
import '../styles/grid.css';
import '../styles/menu.css';
// import { markdown } from '@astropub/md';
import BaseLayout from '../layouts/BaseLayout.astro';

const title = 'Week';
const description = 'Weekly calendar.';
const permalink = `${Astro.site.href}about`;
---

<BaseLayout
  title={title}
  description={description}
  permalink={permalink}
  current="week"
>
  <div id="main">
    <h1 class="header-title">Weekly calendar</h1>
    <div id="grid" class="ui stackable two column grid">
      <div class="zuo column">
        <div id="imageCover" class="cover">
          <div class="intro">
            <div class="inner">
              <div id="last" class="left" style="display: inline-block;">
                ←
              </div>
              <div class="middle">来自: <a id="imageLink" href="http://www.pointfree.cn" target="blank">pointfree</a></div>

              <div id="next" class="right" style="display: inline-block;">
                →
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="you column">
        <div class="you-wrapper">
          <div class="progress">
            <div id="progress" class="label"></div>
          </div>

          <div class="ui today only-screen equal width grid">
            <div class="l five wide column">
              <div id="todaySolar" class="yang">2018.11.30 周五</div>
              <div id="firstSolar" class="yang">2018.11.30</div>
            </div>
            <div class="r column">
              <div id="todayLunar" class="yin">十月廿三</div>
              <div id="firstLunar" class="yin">十月廿三</div>
            </div>
          </div>

          <div class="middle">
            <div class="ui pinfo equal width grid meta">
              <div id="ptitle" class="l title ten wide column">虞美人</div>
              <div id="pauthor" class="r author column">李煜</div>
            </div>
            <div id="pcontent-wrapper">
              <div id="pcontent-grid" class="ui equal width grid">
                <div class="l twelve wide column">
                  <div id="pcontent" class="poetry-content">
                    <p>春花秋月何时了，往事知多少？</p>

                    <p>小楼昨夜又东风，故国不堪回首月明中。</p>

                    <p>雕栏玉砌应犹在，只是朱颜改。</p>

                    <p>问君能有几多愁？恰似一江春水向东流。</p>
                  </div>
                </div>
                <div class="r column">
                  <div class="meta"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="calendar">
            <div class="ui text seven item menu">
              <div id="w1" data-date="2018-08-01" class="item">
                <div>
                  <div class="yang">26</div>
                  <div class="yin">十九</div>
                </div>
              </div>
              <div id="w2" class="item">
                <div>
                  <div class="yang">26</div>
                  <div class="yin">十九</div>
                </div>
              </div>
              <div id="w3" class="item">
                <div>
                  <div class="yang header">26</div>
                  <div class="yin">十九</div>
                </div>
              </div>
              <div id="w4" class="item">
                <div>
                  <div class="yang header">26</div>
                  <div class="yin">十九</div>
                </div>
              </div>
              <div id="w5" class="item">
                <div>
                  <div class="yang header">27</div>
                  <div class="yin">二十</div>
                </div>
              </div>
              <div id="w6" class="item">
                <div>
                  <div class="yang header">28</div>
                  <div class="yin">廿一</div>
                </div>
              </div>
              <div id="w7" class="item">
                <div>
                  <div class="yang header">29</div>
                  <div class="yin">廿二</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  #main {
    overflow: scroll;
  }
  .header-title {
    text-align: center;
  }
  @media (max-width: 1020px) {
    .about-image {
      float: none;
      margin: 0 auto 2em;
    }
  }
</style>

<script>
  import { 
    images, 
    getJijie, 
    JIJIEMAP, 
    getProgress, 
    weekNumber, 
    monDay, 
    weekDays, 
    calendar, 
    weekPoetry, 
    setContentP, 
    pad, 
    lundarDayMap, 
    solarDayMap
  } from "../utils/tools";
  document.querySelector("#last").addEventListener("click", last);
  document.querySelector("#next").addEventListener("click", next);
  document.querySelector("#todayLunar").addEventListener("click", today);
  document.querySelector("#firstLunar").addEventListener("click", today);
  
  var wrappers = ["site-wrapper", "social-links-wrapper", "donation-wrapper", "skin-wrapper"]
  var allImages = Object.values(images)
  let titleSolar = null;
  function render(t) {
    window.day = t;
    var ji = getJijie(t)
    var jijieFlower = JIJIEMAP[ji]
    // 季节花
    document.getElementById("grid").style.backgroundImage = "url('assets/images/" + jijieFlower + ".png')";
    // 进度条
    document.getElementById("progress").style.width = getProgress(t) + '%';

    var currentWeekNumber = weekNumber(t);
    var currentMonday = monDay(t);
    var currentWeeks = weekDays(currentMonday);

    var day = calendar.solar2lunar(t.getFullYear(), t.getMonth() + 1, t.getDate());

    var lunarDate = day.gzYear + '·' + day.IMonthCn + day.IDayCn;
    var solarDate = day.cYear + '.' + day.cMonth + '.' + day.cDay + '   ' + day.ncWeek;

    document.getElementById("todayLunar").innerHTML = lunarDate
    document.getElementById("todaySolar").innerHTML = solarDate


    // Poetry
    var poetry = weekPoetry[currentWeekNumber[1] - 1]

    if (!poetry) {
        var poetry = poetrys[Math.floor(Math.random() * poetrys.length)];
        poetry.content = poetry.paragraphs
    }

    // images
    if (poetry.image) {
        var image = images[poetry.image]
    } else {
        var image = allImages[Math.floor(Math.random() * allImages.length)];
    }

    document.getElementById("imageCover").style.backgroundImage = "url('/assets/weekImages/" + image.src + "')";
    document.getElementById("imageLink").href = image.link;
    document.getElementById("imageLink").innerHTML = image.author;

    // dynasty
    if (poetry.dynasty) {
        var author = poetry.dynasty + '·' + poetry.author;
    } else {
        var author = poetry.author;
    }

    setContentP(poetry.content)
    document.getElementById("ptitle").innerHTML = poetry.title
    document.getElementById("pauthor").innerHTML = author

    var weekIds = ["w1", "w2", "w3", "w4", "w5", "w6", "w7"]
    var firstSolar = ""
    var firstLunar = ""


    for (var i in weekIds) {
        var id = weekIds[i];
        var solar = currentWeeks[i];
        var lunar = calendar.solar2lunar(
            solar.getFullYear(), 
            solar.getMonth() + 1, 
            solar.getDate()
        );


        if (id === 'w1') {
            firstSolar = firstSolar + pad(lunar.cMonth) + '.' + pad(lunar.cDay) + ''
            firstLunar = firstLunar + pad(lunar.IMonthCn) + pad(lunar.IDayCn);
        }


        if (id === 'w7') {
            titleSolar = lunar.cYear + '-' + '第' + pad(currentWeekNumber[1]) + '周';
            firstSolar = firstSolar + '~' + pad(lunar.cMonth) + '.' + pad(lunar.cDay) + ''
            firstLunar = firstLunar + '~' + pad(lunar.IMonthCn) + pad(lunar.IDayCn);
            document.getElementById("firstSolar").innerHTML = firstSolar
            document.getElementById("firstLunar").innerHTML = firstLunar

            document.title = '诗词周历-' + titleSolar + '-' + firstSolar;
        }

        var el = document.getElementById(id);

        if (solar.getDate() === t.getDate()) {
            el.classList.add("active");
            if (lunar.lMonth === 4 && lunar.lDay === 26) {
                setContentP(["祝你生日快乐", "祝你生日快乐", "祝你生日快乐","祝你生日快乐~~"])
                document.getElementById("ptitle").innerHTML = "生日歌"
                document.getElementById("pauthor").innerHTML = "党中央"
            }
        } else {
            el.classList.remove("active")
        }

        console.log(lunar.cYear, window.year)

        if (lunar.cYear !== window.year) {
            el.classList.add('no')
        } else {
            el.classList.remove('no')
        }

        el.getElementsByClassName("yang")[0].innerHTML = lunar.cDay

        var lunarElement = el.getElementsByClassName("yin")[0]

        var nextDay = new Date(solar.getFullYear(),  solar.getMonth(), solar.getDate())
        nextDay.setDate(solar.getDate() + 1);
    
        var nextDay = calendar.solar2lunar(
            nextDay.getFullYear(), 
            nextDay.getMonth() + 1, 
            nextDay.getDate()
        );

        if (nextDay.IMonthCn + nextDay.IDayCn === '正月初一') {
            lunarElement.innerHTML = '除夕'
            continue
        }

        if (nextDay.Term === '清明') {
            lunarElement.innerHTML = '寒食'
            continue
        }

        if (lunar.IMonthCn + lunar.IDayCn in lundarDayMap) {
            lunarElement.innerHTML = lundarDayMap[lunar.IMonthCn + lunar.IDayCn]
            continue
        }

        if (lunar.cMonth + '.' + lunar.cDay in solarDayMap) {
            lunarElement.innerHTML = solarDayMap[lunar.cMonth + '.' + lunar.cDay]
            continue
        }

        if (lunar.Term) {
            lunarElement.innerHTML = lunar.Term
        } else {
            lunarElement.innerHTML = lunar.IDayCn
        }

    }
  }

  function last() {
    window.day.setDate(window.day.getDate() - 1);
    window.year = window.day.getFullYear()
    render(window.day)
  }

  function next() {
    window.day.setDate(window.day.getDate() + 1);
    window.year = window.day.getFullYear()
    render(window.day)
  }

  function today() {
    let today = new Date()
    window.year = today.getFullYear()
    render(today);
  }

  // render(new Date());
  var url = new URL(window.location.href);
  var d = url.searchParams.get("d");

  if (d !== null) {
      var renderDate = new Date(d);
  } else {
      var renderDate = new Date()
  }

  window.year = renderDate.getFullYear()
  render(renderDate)
</script>
